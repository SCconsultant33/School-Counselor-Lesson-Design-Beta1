<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCA-Aligned Lesson Designer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Define a custom color palette for creativity and professionalism */
        :root {
            --color-primary: #6B46C1; /* Deep Purple */
            --color-secondary: #F6AD55; /* Vibrant Orange/Yellow */
            --color-accent: #38B2AC; /* Teal */
            --color-bg-light: #F7FAFC; /* Light Gray */
            --color-text-dark: #2D3748; /* Dark Gray */
        }
        .bg-primary { background-color: var(--color-primary); }
        .text-primary { color: var(--color-primary); }
        .border-primary { border-color: var(--color-primary); }
        .bg-secondary { background-color: var(--color-secondary); }
        .text-secondary { color: var(--color-secondary); }
        .bg-accent { background-color: var(--color-accent); }

        /* Custom scrollbar for a polished look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: var(--color-primary);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: var(--color-bg-light);
        }
        /* Markdown Styling (mimicking professional document look) */
        #lessonOutput h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-secondary);
            padding-bottom: 0.25rem;
        }
        #lessonOutput h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--color-accent);
        }
        #lessonOutput p {
            margin-bottom: 1rem;
        }
        #lessonOutput ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        #lessonOutput li {
            margin-bottom: 0.5rem;
        }
    </style>
    <script>
        // --- Core Configuration and State Management ---
        const MODEL_NAME = 'gemini-2.5-flash-preview-05-20';
        const API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;
        const API_KEY = ""; // Canvas will provide this key at runtime
        const MAX_RETRIES = 5;

        let lessonState = {
            currentLesson: "",
            isGenerating: false,
            initialPrompt: ""
        };

        // --- Utility Functions ---

        /**
         * Generic function to handle API calls with exponential backoff.
         * @param {object} payload - The request body for the Gemini API.
         * @returns {Promise<{text: string, sources: Array<{uri: string, title: string}>}>}
         */
        async function generateContentWithBackoff(payload) {
            const url = `${API_BASE_URL}?key=${API_KEY}`;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < MAX_RETRIES - 1) {
                            // Rate limit exceeded, retry with backoff
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;

                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }
                        return { text, sources };
                    } else {
                         throw new Error("API response was valid but contained no generated text.");
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === MAX_RETRIES - 1) throw error;
                    // Wait before next retry
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Updates the UI state for loading.
         * @param {boolean} isLoading
         */
        function setLoadingState(isLoading) {
            lessonState.isGenerating = isLoading;
            const statusElement = document.getElementById('statusMessage');
            const submitButton = document.getElementById('submitButton');
            const refineButton = document.getElementById('refineButton');

            if (isLoading) {
                statusElement.innerHTML = `
                    <div class="flex items-center space-x-2 text-primary">
                        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Designing your lesson...</span>
                    </div>
                `;
                submitButton.disabled = true;
                if (refineButton) refineButton.disabled = true;
            } else {
                statusElement.innerHTML = '';
                submitButton.disabled = false;
                if (refineButton) refineButton.disabled = false;
            }
        }

        /**
         * Renders the generated lesson plan and enables the refinement interface.
         * @param {string} text - The Markdown lesson plan.
         * @param {Array<object>} sources - The grounding sources.
         */
        function renderLesson(text, sources) {
            lessonState.currentLesson = text;
            const outputElement = document.getElementById('lessonOutput');
            const refinementArea = document.getElementById('refinementArea');
            const statusElement = document.getElementById('statusMessage');

            // --- REFINED MARKDOWN TO HTML CONVERSION (Line-by-Line) ---
            const lines = text.split('\n');
            let inList = false;
            let htmlContent = '';

            for (const line of lines) {
                const trimmedLine = line.trim();
                const isListItem = trimmedLine.startsWith('* ') || trimmedLine.match(/^\d+\.\s/); // Includes numbered lists
                const isHeader = trimmedLine.startsWith('#');
                const isBlank = trimmedLine.length === 0;

                // Handle List Transitions
                if (isListItem && !inList) {
                    htmlContent += '<ul>\n';
                    inList = true;
                } else if (!isListItem && inList) {
                    htmlContent += '</ul>\n';
                    inList = false;
                }

                // Process Line Content
                if (isListItem) {
                    // Remove Markdown list marker (both * and 1. ) and process bold
                    let content = line.replace(/^(\*\s*|\d+\.\s*)/, '').trim();
                    content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    htmlContent += `<li>${content}</li>\n`;
                } else if (trimmedLine.startsWith('##')) {
                    // Handle H2
                    htmlContent += line.replace(/^##\s*(.*)$/, '<h2>$1</h2>') + '\n';
                } else if (trimmedLine.startsWith('#')) {
                    // Handle H1
                    htmlContent += line.replace(/^#\s*(.*)$/, '<h1>$1</h1>') + '\n';
                } else if (!isBlank) {
                    // Treat non-list, non-header, non-blank lines as paragraphs.
                    // Process bold within paragraphs
                    let content = trimmedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    htmlContent += `<p>${content}</p>\n`;
                }
            }

            // Close any open list
            if (inList) {
                htmlContent += '</ul>\n';
            }
            // --- END REFINED MARKDOWN TO HTML CONVERSION ---

            outputElement.innerHTML = `
                <div class="p-6 bg-white shadow-xl rounded-lg ring-4 ring-offset-4 ring-primary/20 transition-all duration-300">
                    <div class="prose max-w-none">
                        ${htmlContent}
                    </div>
                </div>
            `;
            statusElement.innerHTML = ''; // Clear status

            // Render Sources
            const sourceHtml = sources.length > 0
                ? `<div class="mt-4 p-3 bg-gray-50 rounded-lg text-xs text-gray-600 border border-gray-200">
                    <p class="font-semibold mb-1">Sources/Grounding:</p>
                    <ul class="list-disc list-inside space-y-1">
                        ${sources.map(s => `<li><a href="${s.uri}" target="_blank" class="text-primary hover:underline">${s.title}</a></li>`).join('')}
                    </ul>
                   </div>`
                : '';

            outputElement.innerHTML += sourceHtml;


            // Show refinement controls
            refinementArea.innerHTML = `
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-xl font-bold text-text-dark mb-4 flex items-center">
                        <i data-lucide="sparkles" class="w-6 h-6 mr-2 text-secondary"></i>
                        Refine & Collaborate
                    </h3>
                    <textarea id="refinementInput" rows="3" class="w-full p-3 border-2 border-primary/50 rounded-lg focus:border-accent focus:ring focus:ring-accent/50 transition-all duration-300 shadow-inner" placeholder="E.g., 'Make the procedure more focused on small group activities, and link the lesson to CASEL competency Self-Management.'"></textarea>
                    <button id="refineButton" onclick="handleRefine()" class="mt-3 w-full md:w-auto px-6 py-3 bg-accent text-white font-semibold rounded-full shadow-lg hover:bg-accent/80 transition-all duration-300 flex items-center justify-center">
                        <i data-lucide="wand-2" class="w-5 h-5 mr-2"></i>
                        Refine Lesson
                    </button>
                    <div id="statusMessageRefine" class="mt-3 text-sm font-medium"></div>
                </div>
            `;
            // Re-render lucide icons
            lucide.createIcons();
        }

        // --- Event Handlers ---

        /**
         * Handles the initial lesson generation request.
         */
        async function handleSubmit(event) {
            event.preventDefault();
            if (lessonState.isGenerating) return;

            const intention = document.getElementById('lessonIntention').value;
            const grade = document.getElementById('gradeLevel').value;
            const duration = document.getElementById('duration').value;
            const outputElement = document.getElementById('lessonOutput');

            if (!intention || !grade || !duration) {
                document.getElementById('statusMessage').innerHTML = `<p class="text-red-500 font-semibold">Please fill out all required fields.</p>`;
                return;
            }

            setLoadingState(true);
            outputElement.innerHTML = ''; // Clear previous output
            document.getElementById('refinementArea').innerHTML = ''; // Clear refinement area

            const systemPrompt = `You are an expert K-12 School Counselor and Curriculum Designer. Your task is to create a comprehensive, engaging, and age-appropriate classroom lesson plan. The lesson *must* explicitly align with the ASCA Student Standards (Academic, Career, or Social/Emotional). You must select the most appropriate standard based on the lesson intention. Output the complete lesson plan as formatted Markdown only, including the following sections in order: 

# [Lesson Title]
## ASCA Standards Alignment
[State the Domain and the specific Standard/s.]
## Grade Level
[The specific grade level.]
## Duration
[The specified duration.]
## Learning Objectives
[1-3 measurable objectives, corresponding to the duration.]
## Materials
[List all necessary materials.]
## Procedure
[Provide a simple, clean, step-by-step overview as a numbered list. Each step should be one to two concise sentences only, including the approximate timing in parentheses (e.g., (5 minutes)). Use **minimal** Markdown formatting. DO NOT use nested lists or extra characters like asterisks for emphasis. DO NOT use a table format for the procedure.]
## Assessment/Conclusion
[How the lesson will be assessed and concluded.]`;

            const userQuery = `Design a ${duration} lesson for ${grade} students about the following intention: "${intention}".`;

            lessonState.initialPrompt = userQuery; // Store initial prompt for context if needed

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const { text, sources } = await generateContentWithBackoff(payload);
                renderLesson(text, sources);
            } catch (error) {
                console.error("Lesson generation failed:", error);
                document.getElementById('statusMessage').innerHTML = `
                    <p class="text-red-500 font-semibold">Lesson generation failed. Please check your network and try again, or try a different prompt.</p>
                `;
            } finally {
                setLoadingState(false);
            }
        }

        /**
         * Handles the iterative refinement request.
         */
        async function handleRefine() {
            if (lessonState.isGenerating) return;

            const refinementInput = document.getElementById('refinementInput').value;
            const statusElement = document.getElementById('statusMessageRefine');
            const outputElement = document.getElementById('lessonOutput');

            if (!refinementInput) {
                statusElement.innerHTML = `<p class="text-red-500 font-semibold">Please enter your refinement request.</p>`;
                return;
            }

            setLoadingState(true);
            statusElement.innerHTML = ''; // Clear status

            const systemPrompt = `You are an expert K-12 School Counselor and Curriculum Designer specializing in the ASCA standards. Your task is to REVISE and IMPROVE the provided lesson plan based on the user's specific feedback. Maintain the required structure (Title, ASCA Standards, Grade Level, Duration, Objectives, Materials, Procedure, Assessment). For the **Procedure** section, ensure it is provided as a simple, clean, step-by-step numbered overview. Each step should be one to two concise sentences only, including the approximate timing. Use **minimal** Markdown formatting. Output the *complete, revised* lesson plan as formatted Markdown only. Do not add any conversational text before or after the plan.`;

            // Combine the current lesson plan and the user's feedback into the chat history
            const chatHistory = [
                {
                    role: "user",
                    parts: [{ text: `Original Lesson Plan:\n\n---\n\n${lessonState.currentLesson}\n\n---\n\nRefinement Request: ${refinementInput}` }]
                }
            ];

            const payload = {
                contents: chatHistory,
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                outputElement.innerHTML = '<div class="text-center p-8"><p class="text-lg text-primary font-semibold">Refining lesson plan...</p></div>';
                const { text, sources } = await generateContentWithBackoff(payload);

                // Update the state and UI
                renderLesson(text, sources);
                document.getElementById('refinementInput').value = ''; // Clear refinement input
                statusElement.innerHTML = `<p class="text-green-600 font-semibold">Refinement successful!</p>`;

            } catch (error) {
                console.error("Refinement failed:", error);
                statusElement.innerHTML = `
                    <p class="text-red-500 font-semibold">Refinement failed. Please try again.</p>
                `;
            } finally {
                setLoadingState(false);
            }
        }

        // Initialize Lucide icons on window load
        window.onload = () => {
            lucide.createIcons();
        };

    </script>
</head>
<body class="bg-gray-100 font-sans antialiased text-color-text-dark min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto space-y-8">
        <!-- Header -->
        <header class="text-center p-6 bg-white rounded-xl shadow-lg border-b-4 border-primary">
            <h1 class="text-4xl font-extrabold text-primary flex items-center justify-center">
                <i data-lucide="book-open-text" class="w-8 h-8 mr-3 text-secondary"></i>
                ASCA Lesson Design Studio
            </h1>
            <p class="mt-2 text-lg text-gray-600">Aligning creativity with standards for K-12 counseling lessons.</p>
        </header>

        <!-- Input Card -->
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl border-l-8 border-accent">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="pencil" class="w-6 h-6 mr-2 text-primary"></i>
                Lesson Concept
            </h2>
            <form id="lessonForm" onsubmit="handleSubmit(event)" class="space-y-4">
                <!-- Lesson Intention -->
                <div>
                    <label for="lessonIntention" class="block text-sm font-medium text-gray-700 mb-1">
                        Lesson Intention / Topic Description <span class="text-red-500">*</span>
                    </label>
                    <textarea id="lessonIntention" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition-all duration-200 shadow-sm" placeholder="e.g., How to handle friend conflicts peacefully, or career pathways in STEM."></textarea>
                </div>

                <!-- Grade & Duration -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="gradeLevel" class="block text-sm font-medium text-gray-700 mb-1">
                            Target Grade Level <span class="text-red-500">*</span>
                        </label>
                        <select id="gradeLevel" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition-all duration-200 shadow-sm appearance-none bg-white">
                            <option value="">Select Grade</option>
                            <option value="Kindergarten">Kindergarten</option>
                            <option value="1st Grade">1st Grade</option>
                            <option value="2nd Grade">2nd Grade</option>
                            <option value="3rd Grade">3rd Grade</option>
                            <option value="4th Grade">4th Grade</option>
                            <option value="5th Grade">5th Grade</option>
                            <option value="6th Grade">6th Grade</option>
                            <option value="7th Grade">7th Grade</option>
                            <option value="8th Grade">8th Grade</option>
                            <option value="9th Grade">9th Grade</option>
                            <option value="10th Grade">10th Grade</option>
                            <option value="11th Grade">11th Grade</option>
                            <option value="12th Grade">12th Grade</option>
                        </select>
                    </div>
                    <div>
                        <label for="duration" class="block text-sm font-medium text-gray-700 mb-1">
                            Duration <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="duration" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition-all duration-200 shadow-sm" placeholder="e.g., 30 minutes, 45 minutes, 1 hour">
                    </div>
                </div>

                <!-- Submission and Status -->
                <div class="pt-4">
                    <button id="submitButton" type="submit" class="w-full px-6 py-3 bg-primary text-white font-bold rounded-full text-lg shadow-xl transform hover:scale-[1.01] transition-all duration-300 flex items-center justify-center">
                        <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
                        Generate Initial Lesson Plan
                    </button>
                    <div id="statusMessage" class="mt-3 text-center font-medium h-6"></div>
                </div>
            </form>
        </div>

        <!-- Output and Refinement Area -->
        <div id="lessonSection">
            <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4 flex items-center">
                <i data-lucide="file-text" class="w-6 h-6 mr-2 text-primary"></i>
                Generated Lesson Plan
            </h2>
            <!-- Lesson Plan Output -->
            <div id="lessonOutput" class="min-h-[150px] bg-white p-2 rounded-xl shadow-inner custom-scrollbar overflow-y-auto">
                <p class="text-center text-gray-500 p-10">Your generated lesson plan will appear here after submission.</p>
            </div>

            <!-- Refinement Controls -->
            <div id="refinementArea" class="mt-4">
                <!-- Content injected by JS after initial generation -->
            </div>
        </div>

        <!-- Footer for ASCA context -->
        <footer class="text-center text-sm text-gray-500 pt-8">
            <p>This tool is designed to support, not replace, professional judgment. Lessons generated are automatically aligned with current ASCA Student Standards using generative AI.</p>
        </footer>
    </div>

</body>
</html>
